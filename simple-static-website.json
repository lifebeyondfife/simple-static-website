{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Cloudfront-ed S3 Bucket",
  "Parameters": {
      "WebsiteName": {
          "Type": "String",
          "Description": "E.g. the \"www\" in www.example.com"
      },
      "BucketName": {
          "Type": "String",
          "Default": "",
          "Description": "If not supplied, a bucket will be created and named after the stack"
      },
      "DomainName": {
          "Type": "String",
          "Description": "E.g. \"example.com\" in www.example.com"
      },
      "HostedZoneId": {
          "Type": "AWS::Route53::HostedZone::Id",
          "Description": "You must already have a Hosted Zone setup for your domain in Route53."
      }
  },
  "Metadata": {
      "AWS::CloudFormation::Interface": {
          "ParameterGroups": [
              {
                  "Label": {
                      "default": "DNS"
                  },
                  "Parameters": [
                      "HostedZoneId",
                      "WebsiteName",
                      "DomainName"
                  ]
              },
              {
                  "Label": {
                      "default": "Optional"
                  },
                  "Parameters": [
                      "BucketName"
                  ]
              }
          ],
          "ParameterLabels": {
              "BucketName": {
                  "default": "Existing S3 Bucket Name"
              },
              "DomainName": {
                  "default": "Domain Name"
              },
              "WebsiteName": {
                  "default": "Website Name"
              },
              "HostedZoneId": {
                  "default": "Hosted Zone Id"
              }
          }
      }
  },
  "Conditions": {
      "BucketNameEmpty": {
          "Fn::Equals": [
              {
                  "Ref": "BucketName"
              },
              ""
          ]
      }
  },
  "Resources": {
      "Certificate": {
          "Type": "AWS::CertificateManager::Certificate",
          "Properties": {
              "DomainName": {
                  "Fn::Sub": "${WebsiteName}.${DomainName}"
              },
              "DomainValidationOptions": [
                  {
                      "DomainName": {
                          "Fn::Sub": "${WebsiteName}.${DomainName}"
                      },
                      "HostedZoneId": {
                          "Ref": "HostedZoneId"
                      }
                  }
              ],
              "ValidationMethod": "DNS"
          }
      },
      "ARecordSet": {
          "Type": "AWS::Route53::RecordSet",
          "Properties": {
              "AliasTarget": {
                  "HostedZoneId": "Z2FDTNDATAQYW2",
                  "DNSName": {
                      "Fn::GetAtt": [
                          "DistributionCloudFrontNet",
                          "DomainName"
                      ]
                  }
              },
              "HostedZoneId": {
                  "Ref": "HostedZoneId"
              },
              "Name": {
                  "Fn::Sub": "${WebsiteName}.${DomainName}"
              },
              "Type": "A"
          }
      },
      "AAAARecordSet": {
          "Type": "AWS::Route53::RecordSet",
          "Properties": {
              "AliasTarget": {
                  "HostedZoneId": "Z2FDTNDATAQYW2",
                  "DNSName": {
                      "Fn::GetAtt": [
                          "DistributionCloudFrontNet",
                          "DomainName"
                      ]
                  }
              },
              "HostedZoneId": {
                  "Ref": "HostedZoneId"
              },
              "Name": {
                  "Fn::Sub": "${WebsiteName}.${DomainName}"
              },
              "Type": "AAAA"
          }
      },
      "HTML": {
          "Type": "AWS::S3::Bucket",
          "Condition": "BucketNameEmpty",
          "Properties": {
              "WebsiteConfiguration": {
                  "IndexDocument": "index.html"
              },
              "BucketName": {
                  "Fn::Sub": "${WebsiteName}.${DomainName}"
              },
              "PublicAccessBlockConfiguration": {
                "BlockPublicAcls": false,
                "BlockPublicPolicy": false,
                "IgnorePublicAcls": false,
                "RestrictPublicBuckets": false
              }
          },
          "DeletionPolicy": "Retain",
          "UpdateReplacePolicy": "Retain"
      },
      "ResponseHeadersPolicy": {
          "Type": "AWS::CloudFront::ResponseHeadersPolicy",
          "Properties": {
              "ResponseHeadersPolicyConfig": {
                  "Name": {
                      "Fn::Sub": "${AWS::StackName}-security-headers"
                  },
                  "SecurityHeadersConfig": {
                      "StrictTransportSecurity": {
                          "AccessControlMaxAgeSec": 31536000,
                          "IncludeSubdomains": true,
                          "Override": true
                      },
                      "ContentTypeOptions": {
                          "Override": true
                      },
                      "FrameOptions": {
                          "FrameOption": "DENY",
                          "Override": true
                      },
                      "ReferrerPolicy": {
                          "ReferrerPolicy": "strict-origin-when-cross-origin",
                          "Override": true
                      }
                  }
              }
          }
      },
      "DistributionCloudFrontNet": {
          "Type": "AWS::CloudFront::Distribution",
          "Properties": {
              "DistributionConfig": {
                  "Aliases": [
                      {
                          "Fn::Sub": "${WebsiteName}.${DomainName}"
                      }
                  ],
                  "Enabled": true,
                  "HttpVersion": "http2",
                  "PriceClass": "PriceClass_100",
                  "DefaultRootObject": "index.html",
                  "CustomErrorResponses": [
                      {
                          "ErrorCode": 403,
                          "ResponseCode": 404,
                          "ResponsePagePath": "/404.html",
                          "ErrorCachingMinTTL": 300
                      },
                      {
                          "ErrorCode": 404,
                          "ResponseCode": 404,
                          "ResponsePagePath": "/404.html",
                          "ErrorCachingMinTTL": 300
                      }
                  ],
                  "DefaultCacheBehavior": {
                      "TargetOriginId": {
                          "Fn::If": [
                              "BucketNameEmpty",
                              {
                                  "Fn::Sub": "S3-origin-${HTML}"
                              },
                              {
                                  "Fn::Sub": "S3-origin-${BucketName}"
                              }
                          ]
                      },
                      "ViewerProtocolPolicy": "redirect-to-https",
                      "AllowedMethods": [
                          "HEAD",
                          "GET"
                      ],
                      "CachedMethods": [
                          "HEAD",
                          "GET"
                      ],
                      "ForwardedValues": {
                        "QueryString": false,
                        "Cookies": {
                            "Forward": "none"
                        }
                      },
                      "ResponseHeadersPolicyId": {
                          "Ref": "ResponseHeadersPolicy"
                      }
                  },
                  "Origins": [
                      {
                          "DomainName": {
                              "Fn::If": [
                                  "BucketNameEmpty",
                                  {
                                      "Fn::Sub": "${HTML}.s3-website-${AWS::Region}.amazonaws.com"
                                  },
                                  {
                                      "Fn::Sub": "${BucketName}.s3-website-${AWS::Region}.amazonaws.com"
                                  }
                              ]
                          },
                          "Id": {
                              "Fn::If": [
                                  "BucketNameEmpty",
                                  {
                                      "Fn::Sub": "S3-origin-${HTML}"
                                  },
                                  {
                                      "Fn::Sub": "S3-origin-${BucketName}"
                                  }
                              ]
                          },
                          "CustomOriginConfig": {
                            "HTTPPort": 80,
                            "OriginProtocolPolicy": "http-only"
                          }
                      }
                  ],
                  "Restrictions": {
                      "GeoRestriction": {
                          "RestrictionType": "none",
                          "Locations": []
                      }
                  },
                  "ViewerCertificate": {
                      "SslSupportMethod": "sni-only",
                      "MinimumProtocolVersion": "TLSv1.2_2021",
                      "AcmCertificateArn": {
                          "Ref": "Certificate"
                      }
                  }
              }
          }
      },
      "BucketPolicy": {
          "Type": "AWS::S3::BucketPolicy",
          "Properties": {
              "Bucket": {
                  "Fn::If": [
                      "BucketNameEmpty",
                      {
                          "Ref": "HTML"
                      },
                      {
                          "Ref": "BucketName"
                      }
                  ]
              },
              "PolicyDocument": {
                  "Version": "2012-10-17",
                  "Statement": [
                      {
                          "Effect": "Allow",
                          "Principal": "*",
                          "Action": "s3:GetObject",
                          "Resource": {
                              "Fn::If": [
                                  "BucketNameEmpty",
                                  {
                                      "Fn::Sub": "arn:aws:s3:::${HTML}/*"
                                  },
                                  {
                                      "Fn::Sub": "arn:aws:s3:::${BucketName}/*"
                                  }
                              ]
                          }
                      }
                  ]
              }
          }
      }
  },
  "Outputs": {
      "Route53URL": {
          "Value": {
              "Fn::Sub": "https://${ARecordSet}"
          },
          "Description": "Simple website URL (remember to put some HTML in the S3 bucket)"
      },
      "CloudFrontURL": {
          "Value": {
              "Fn::GetAtt": [
                  "DistributionCloudFrontNet",
                  "DomainName"
              ]
          },
          "Description": "CloudFront URL"
      },
      "Upload": {
          "Value": {
              "Fn::If": [
                  "BucketNameEmpty",
                  {
                      "Fn::Sub": "aws s3 cp index.html s3://${HTML}"
                  },
                  {
                      "Fn::Sub": "aws s3 cp index.html s3://${BucketName}"
                  }
              ]
          },
          "Description": "Upload your first file"
      }
  }
}
